<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExGPT 4.0 Cloud - Ultra</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-color: #080808;
            --chat-bg: #0c0c0c;
            --text-color: #e0e0e0;
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.3);
            --user-bubble: #1a1a1a;
            --ai-bubble: #121212;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); overflow: hidden; }
        .bg-glow { position: fixed; top: -10%; left: -10%; width: 40%; height: 40%; background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%); z-index: -1; filter: blur(50px); }

        #login-screen { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: rgba(20,20,20,0.8); backdrop-filter: blur(20px); padding: 40px; border-radius: 30px; border: 1px solid #222; text-align: center; width: 320px; box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
        .login-card input { width: 100%; padding: 15px; margin: 20px 0; border-radius: 12px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; outline: none; }

        #app { display: flex; flex-direction: column; height: 100vh; max-width: 1000px; margin: 0 auto; background: var(--chat-bg); position: relative; border-left: 1px solid #1a1a1a; border-right: 1px solid #1a1a1a; }
        header { padding: 20px; text-align: center; border-bottom: 1px solid #1a1a1a; background: rgba(0,0,0,0.4); }
        header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 3px; color: var(--accent); text-shadow: 0 0 10px var(--accent-glow); }

        #chat-window { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px; }
        .msg-row { display: flex; gap: 12px; width: 100%; animation: fadeInUp 0.4s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .user-row { flex-direction: row-reverse; }
        .system-row { justify-content: center; opacity: 0.8; font-weight: bold; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; }

        .avatar { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; flex-shrink: 0; background: #222; color: #fff; }
        .bubble { max-width: 75%; padding: 14px 18px; border-radius: 20px; font-size: 15px; line-height: 1.6; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .user-bubble { background: var(--user-bubble); border-bottom-right-radius: 4px; border: 1px solid #333; }
        .ai-bubble { background: var(--ai-bubble); border: 1px solid #222; border-bottom-left-radius: 4px; }
        .bubble img { max-width: 100%; border-radius: 12px; margin-top: 10px; display: block; border: 1px solid #333; }

        #status { padding: 10px 25px; font-size: 12px; color: var(--accent); display: none; font-style: italic; }

        .input-area { padding: 20px; background: rgba(0,0,0,0.5); border-top: 1px solid #1a1a1a; }
        .input-wrap { display: flex; background: #111; border-radius: 18px; padding: 10px 15px; border: 1px solid #222; gap: 12px; align-items: center; }
        .input-wrap input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 16px; }
        
        .btn { background: var(--accent); border: none; color: #000; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        .attach-btn { color: #666; cursor: pointer; font-size: 24px; transition: 0.3s; }

        #admin-panel { display: none; position: absolute; inset: 0; background: #000; z-index: 5000; flex-direction: row; }
        #admin-sidebar { width: 240px; border-right: 1px solid #222; background: #050505; }
        #admin-main { flex: 1; padding: 30px; display: flex; flex-direction: column; }
        .chat-tab { padding: 15px 20px; border-bottom: 1px solid #111; cursor: pointer; color: #666; font-size: 13px; }
        .chat-tab.active { background: #111; color: var(--accent); border-left: 4px solid var(--accent); }
    </style>
</head>
<body>

<div class="bg-glow"></div>
<div id="login-screen">
    <div class="login-card">
        <h1 style="color:var(--accent); margin:0;">ExGPT 4.0</h1>
        <p style="color:#666; font-size: 11px; letter-spacing: 2px;">SECURE CONNECTION</p>
        <input type="text" id="user-nick" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫..." maxlength="12">
        <button class="btn" style="width:100%" onclick="initChat()">CONNECT</button>
    </div>
</div>

<div id="app">
    <header><h1>EXGPT <span style="font-size:9px; opacity:0.5;">ULTRA CLOUD</span></h1></header>
    <div id="chat-window"></div>
    <div id="status">–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç...</div>
    <div class="input-area">
        <div class="input-wrap">
            <input type="file" id="file-input" style="display:none" accept="image/*" onchange="uploadImage(this)">
            <div class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</div>
            <input type="text" id="user-msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="handleUserSend()" class="btn">GO</button>
        </div>
    </div>

    <div id="admin-panel">
        <div id="admin-sidebar">
            <div style="padding:25px; font-size:10px; color:gray; letter-spacing:2px;">DATABASE_CHATS</div>
            <div id="chat-tabs-list"></div>
            <button onclick="clearCloud()" style="padding:20px; color:red; background:none; border:none; cursor:pointer; font-size:10px;">PURGE ALL DATA</button>
        </div>
        <div id="admin-main">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="active-chat-name" style="margin:0;">Terminal</h2>
                <button onclick="closeAdmin()" class="btn" style="background:red; color:white;">EXIT</button>
            </div>
            <div id="admin-log" style="flex:1; background:#050505; border:1px solid #222; padding:20px; overflow-y:auto; font-family:monospace; color:#00ff88; margin-bottom:20px; border-radius:15px;"></div>
            <div style="background:#111; padding:20px; border-radius:20px; border:1px solid #222;">
                <div style="margin-bottom:15px; display:flex; gap:20px; align-items:center;">
                    –ù–∏–∫: <input type="text" id="admin-nick" value="GPT" style="background:#000; border:1px solid #333; color:white; padding:8px; border-radius:8px; width:80px;">
                    –¶–≤–µ—Ç: <input type="color" id="admin-color" value="#00ff88">
                    <label style="font-size:12px; cursor:pointer;"><input type="checkbox" id="is-sys"> SYSTEM_MODE</label>
                </div>
                <textarea id="admin-reply-box" style="width:100%; height:80px; background:#000; border:1px solid #333; color:white; border-radius:12px; padding:15px; resize:none;" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                <button class="btn" style="width:100%; margin-top:15px;" onclick="handleAdminReply()">SEND RESPONSE</button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAMz7N69qYWssb2KqsRAu79Km55tsJJa10",
        authDomain: "exgpttroll.firebaseapp.com",
        databaseURL: "https://exgpttroll-default-rtdb.firebaseio.com",
        projectId: "exgpttroll",
        storageBucket: "exgpttroll.firebasestorage.app",
        messagingSenderId: "957855627150",
        appId: "1:957855627150:web:2350a1345a290dd60f16df"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUserName = "";
    let allChats = {};
    let selectedChat = null;
    const msgSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

    db.ref('chats').on('value', (snap) => {
        allChats = snap.val() || {};
        renderMessages();
        renderAdminTabs();
        renderAdminLog();
        checkTypingStatus();
    });

    function initChat() {
        const nick = document.getElementById('user-nick').value.trim();
        if(!nick) return;
        currentUserName = nick;
        document.getElementById('login-screen').style.display = 'none';
        
        // –°–æ–∑–¥–∞–µ–º —á–∞—Ç
        if(!allChats[nick]) {
            sendToDB(nick, 'GPT', '–ü—Ä–∏–≤–µ—Ç! –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', '#00ff88', false, false);
        }

        // –ù–ê–°–¢–†–û–ô–ö–ê –£–î–ê–õ–ï–ù–ò–Ø –ü–†–ò –í–´–•–û–î–ï
        const chatRef = db.ref('chats/' + nick);
        const presenceRef = db.ref('chats/' + nick + '/isOnline');
        
        // –ö–æ–≥–¥–∞ —é–∑–µ—Ä –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è
        presenceRef.onDisconnect().set(false).then(() => {
            // –ü–∏—à–µ–º –≤ —á–∞—Ç –∞–¥–º–∏–Ω—É –∏ —é–∑–µ—Ä—É, —á—Ç–æ –≤—ã—Ö–æ–¥ —Å–æ–≤–µ—Ä—à–µ–Ω
            const exitMsg = {
                sender: "SYSTEM",
                text: "‚ö†Ô∏è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–û–ö–ò–ù–£–õ –ß–ê–¢. –°–ê–ú–û–£–ù–ò–ß–¢–û–ñ–ï–ù–ò–ï –ß–ï–†–ï–ó 20 –°–ï–ö–£–ù–î.",
                color: "#ff0000",
                isSystem: true,
                isUser: false
            };
            db.ref('chats/' + nick + '/messages').onDisconnect().push(exitMsg);
            
            // –°—Ç–∞–≤–∏–º —Ç–∞–π–º–µ—Ä –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ–π –≤–µ—Ç–∫–∏ —á–µ—Ä–µ–∑ 20 —Å–µ–∫ –ø–æ—Å–ª–µ –¥–∏—Å–∫–æ–Ω–Ω–µ–∫—Ç–∞
            // (–≠—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ Firebase)
            db.ref('chats/' + nick).onDisconnect().cancel(); // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–æ—Å
            setTimeout(() => {
                // –ú—ã –Ω–µ –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ onDisconnect –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ 20 —Å–µ–∫, 
                // –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ–Ω–ª–∞–π–Ω–∞ –≤ renderAdminTabs.
            }, 0);
        });
        presenceRef.set(true);
    }

    // –°–ª–µ–¥–∏–º –∑–∞ —Å–ø–∏—Å–∫–æ–º —á–∞—Ç–æ–≤ –∏ —É–¥–∞–ª—è–µ–º "–º–µ—Ä—Ç–≤—ã–µ"
    setInterval(() => {
        Object.keys(allChats).forEach(id => {
            if (allChats[id].isOnline === false && !allChats[id].deletionTimerStarted) {
                db.ref('chats/' + id + '/deletionTimerStarted').set(true);
                setTimeout(() => {
                    db.ref('chats/' + id).remove();
                }, 20000); // 20 —Å–µ–∫—É–Ω–¥
            }
        });
    }, 5000);

    function checkTypingStatus() {
        if(currentUserName && allChats[currentUserName]) {
            const isTyping = allChats[currentUserName].isTyping || false;
            document.getElementById('status').style.display = isTyping ? 'block' : 'none';
        }
    }

    function uploadImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const formData = new FormData();
            formData.append("image", file);
            fetch("https://api.imgbb.com/1/upload?key=6d207e02198a847aa98d0a2a901485a5", {
                method: "POST",
                body: formData
            }).then(r => r.json()).then(res => {
                if (res.success) {
                    let color = (currentUserName === 'Aduse17') ? '#00ff88' : '#e0e0e0';
                    sendToDB(currentUserName, currentUserName, res.data.url, color, false, true);
                    db.ref('chats/' + currentUserName + '/isTyping').set(true);
                }
            });
        };
        reader.readAsDataURL(file);
    }

    function handleUserSend() {
        const txt = document.getElementById('user-msg-input').value.trim();
        if(!txt) return;
        if(txt === "/Sysmin10") { document.getElementById('admin-panel').style.display = 'flex'; return; }
        let color = (currentUserName === 'Aduse17') ? '#00ff88' : '#e0e0e0';
        sendToDB(currentUserName, currentUserName, txt, color, false, true);
        db.ref('chats/' + currentUserName + '/isTyping').set(true);
        document.getElementById('user-msg-input').value = "";
        msgSound.play().catch(() => {});
    }

    function handleAdminReply() {
        const txt = document.getElementById('admin-reply-box').value.trim();
        if(!txt || !selectedChat) return;
        sendToDB(selectedChat, document.getElementById('admin-nick').value, txt, document.getElementById('admin-color').value, document.getElementById('is-sys').checked, false);
        db.ref('chats/' + selectedChat + '/isTyping').set(false);
        document.getElementById('admin-reply-box').value = "";
    }

    function sendToDB(chat, sender, text, color, isSystem, isUser) {
        db.ref('chats/' + chat + '/messages').push({ sender, text, color, isSystem, isUser });
    }

    function isImgUrl(url) { return (url.match(/\.(jpeg|jpg|gif|png|webp)$/) != null) || url.includes("ibb.co"); }

    function renderMessages() {
        const win = document.getElementById('chat-window');
        if(!currentUserName || !allChats[currentUserName]) return;
        win.innerHTML = "";
        const msgs = allChats[currentUserName].messages || {};
        Object.values(msgs).forEach(m => {
            const div = document.createElement('div');
            let isAduse = m.sender === 'Aduse17';
            div.className = 'msg-row ' + (m.isUser && !isAduse ? 'user-row' : (m.isSystem ? 'system-row' : ''));
            let content = isImgUrl(m.text) ? `<img src="${m.text}" onclick="window.open('${m.text}')">` : m.text;
            if(m.isSystem) {
                div.innerHTML = `<div style="color:${m.color}; text-align:center;">${content}</div>`;
            } else {
                div.innerHTML = `
                <div class="avatar" style="border:1px solid ${(!m.isUser || isAduse) ? m.color : '#333'}">${m.sender[0]}</div>
                <div class="bubble ${(m.isUser && !isAduse) ? 'user-bubble' : 'ai-bubble'}" style="color:${(!m.isUser || isAduse) ? m.color : '#fff'}">
                    <div style="font-size:10px; font-weight:bold; margin-bottom:4px; opacity:0.6;">${m.sender}</div>${content}
                </div>`;
            }
            win.appendChild(div);
        });
        win.scrollTop = win.scrollHeight;
    }

    function renderAdminTabs() {
        const list = document.getElementById('chat-tabs-list');
        list.innerHTML = "";
        Object.keys(allChats).forEach(name => {
            const d = document.createElement('div');
            d.className = 'chat-tab ' + (selectedChat === name ? 'active' : '');
            let statusIcon = allChats[name].isOnline ? 'üü¢' : 'üî¥';
            d.innerText = statusIcon + ' ' + name;
            d.onclick = () => { selectedChat = name; document.getElementById('active-chat-name').innerText = name; renderAdminTabs(); renderAdminLog(); };
            list.appendChild(d);
        });
    }

    function renderAdminLog() {
        const log = document.getElementById('admin-log');
        if(!selectedChat || !allChats[selectedChat]) return;
        log.innerHTML = "";
        const msgs = allChats[selectedChat].messages || {};
        Object.values(msgs).forEach(m => {
            let txt = isImgUrl(m.text) ? "[IMAGE]" : m.text;
            log.innerHTML += `<div><span style="color:gray">[${m.sender}]:</span> ${txt}</div>`;
        });
        log.scrollTop = log.scrollHeight;
    }

    function clearCloud() { if(confirm("Purge?")) db.ref('/').remove(); }
    function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
</script>
</body>
</html>
